import pandas as pd
import glob
import numpy as np

folder_path = "data/"
output_file = "merged_catalog.xlsx"

files = glob.glob(folder_path + "*.xlsx")
dfs = []

for file in files:
    df = pd.read_excel(file)
    dfs.append(df)

merged_df = pd.concat(dfs, axis=0, ignore_index=True)

column_mapping = {
    "Производитель": [
        "Бренд", 
        "Производитель", 
        "Заводская маркировка"
    ],
    "Мощность в режиме охлаждения": [
        "Холодопроизводительность (кВт)", 
        "Номинальная холодопроизводительность, кВт",
        "Номинальная холодопроизводительность",
        "Охлаждение (кВт)",
        "Произв. холод, кВт",
        "Производительность холод , кВт",
        "Холодопроизводительность (Выс./Ср./Низк.), кВт",
        "Охлаждение максимум (Вт)",
        "Охлаждение (Вт)",
        "Холодопроизводительность",
        "Холодопроизводительность (kBTU)",
        "Мощность кондиционера , тыс.BTU"
    ],
    "Тип хладагента": [
        "Тип хладагента", 
        "Марка фреона"
    ],
    "Цвет": [
        "Цвет внутреннего блока", 
        "Цвет прибора", 
        "Цвет", 
        "Цвет наружного блока"
    ],
    "Класс энергопотребления": [
        "Класс энергопотребления", 
        "Класс энергоэффективности (охлаждение)",
        "Класс энергоэффективности EER (охлаждение)",
        "Класс сезонной энергетической эффективности",
        "Класс энергетической эффективности"
    ],
    "Инвертор/Тип компрессора": [
        "Инверторная технология", 
        "Тип компрессора", 
        "Инвертор", 
        "Инверторный компрессор",
        "Тип управления компрессором"
    ],
    "Основные режимы (режим работы)": [
        "Режим работы", 
        "Основные режимы (режим работы)",
        "Режимы работы",
        "Дополнительные режимы"
    ],
    "Уровень шума": [
        "Уровень шума внутреннего блока, дБ(А)",
        "Уровень шума внутреннего блока",
        "Уровень звукового давления дБ(А)",
        "Уровень шума дБ(А)",
        "Уровень звукового давления (Выс/Ср/Низ/Сверх) дБ(А)",
        "Уровень шума (Низк./Ср./Выс. скорость), дБ(А)",
        "Уровень шума, дБ(A)",
        "Мин. уровень шума , дБ(А)",
        "Минимальный уровень шума внутреннего блока",
        "Уровень звуковой мощности дБ(А)"
    ],
    "Максимальная длина коммуникаций": [
        "Максимальная длина трассы",
        "Max.длина магистрали , м",
        "Длина трассы, м",
        "Максимальная длина труб, м",
        "Максимальная суммарная длина трассы",
        "Максимальная длина трубопровода (Эквивалентная/Действительная) (м)",
        "Макс. длина трубопроводов без дополнительной заправки (м)",
        "Максимальная длина трубы между наружным и внутренним блоками (м)",
        "Максимальная суммарная длина трубопровода (м)",
        "Длина трассы до 1-го блока , м",
        "Длина трассы до 1-го блока, м"
    ],
    "Модель": [
        "Название", 
        "Модель", 
        "Модель внутреннего блока"
    ],
    "Изображение": [
        "Изображения", 
        "Файлы"
    ]
}

final_data = pd.DataFrame()

for target_col, source_cols in column_mapping.items():
    found_col = None
    for col in source_cols:
        if col in merged_df.columns:
            found_col = col
            break
    
    if found_col:
        final_data[target_col] = merged_df[found_col]
    else:
        final_data[target_col] = np.nan

filter_keywords = [
    "Дополнительные фильтры тонкой очистки в комплекте",
    "Фильтра",
    "Воздушный фильтр",
    "Тип фильтра и класс очистки"
]

filter_boolean_cols = [col for col in merged_df.columns if "фильтр тонкой очистки" in col.lower() and col not in filter_keywords]

def get_filters(row):
    found_filters = []
    
    for kw in filter_keywords:
        if kw in merged_df.columns and pd.notna(row[kw]) and str(row[kw]).strip() != "":
            found_filters.append(str(row[kw]))
            
    for b_col in filter_boolean_cols:
        val = str(row[b_col]).strip().lower()
        if val in ['да', '+', 'yes', 'true', '1', 'есть']:
            clean_name = b_col.replace("Дополнительный фильтр тонкой очистки ", "")
            found_filters.append(clean_name)
            
    if found_filters:
        return ", ".join(found_filters)
    return np.nan

final_data["Фильтры тонкой очистки воздуха"] = merged_df.apply(get_filters, axis=1)

if "Артикул" in merged_df.columns:
    final_data.insert(0, "Артикул", merged_df["Артикул"])
    final_data = final_data.drop_duplicates(subset=["Артикул"], keep='first')
else:
    final_data = final_data.drop_duplicates(keep='first')

target_order = [
    "Производитель", "Мощность в режиме охлаждения", "Тип хладагента", "Цвет",
    "Класс энергопотребления", "Инвертор/Тип компрессора", "Фильтры тонкой очистки воздуха",
    "Основные режимы (режим работы)", "Уровень шума", "Максимальная длина коммуникаций",
    "Модель", "Изображение"
]

if "Артикул" in final_data.columns:
    target_order.insert(0, "Артикул")

final_data = final_data.reindex(columns=target_order)

final_data.to_excel(output_file, index=False)